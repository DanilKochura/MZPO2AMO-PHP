# Интеграция с amoCRM

В основе интеграции - [API amoCRM](https://www.amocrm.ru/developers/content/crm_platform/api-reference) и их [PHP-бибиотека](https://github.com/amocrm/amocrm-api-php)

### Содержание
1. [Архитектура проекта](#архитектура-проекта)
2. [Авторизация](#авторизация)
3. [Модели](#модели)
4. [Очереди](#очереди)
5. [Хуки](#хуки)
6. [1с](#интеграция-для-1с)
7. [Константы](#константы)
8. [Настройки](#настройки)


## Архитектура проекта

* [1c](/amo/1с) - реализует один метод - создание заявко отдела сопровождения из 1с (будет релоцировано) (см. [1с](#интеграция-для-1с))
* [api](/amo/api) - директория для внешних api. В данный момент реализует интеграцию товаров из 1с.  (см. [1с](#интеграция-для-1с))
* [config](/amo/config) - файлы настройки проекта - подключение к БД, служебные функции (см. [Настройки](#настройки))
* [dict](/amo/dict) - интерфейсы для хранения констант (см. [Константы](#константы))
* [logs](/amo/logs) - директория для хранения логов
* [model](/amo/model) - определение основых моделей сущностей амо (см. [Модели](#модели) )
* [queue](/amo/queue) - подписчики очередей (см. [Очереди](#очереди) )
* [services](/amo/services) - служебные сервисы (см. [Модели](#модели) )
* [reports](/amo/reports) - задатки сервиса для хранения отчетов о событиях. Не реализовано. Не используется.
* [vidgets](/amo/vidgets) - файлы кастомных виджетов для рабочего стола амо


## Авторизация

**Авторизация** в API amoCRM    происходит по протоколу OAuth2, 
замена и сохранение токенов происходят автоматически, эта процедура вшита в конструктор класса [MzpoAmo](/amo/model/MzpoAmo.php). 
При создании объектов его классов-наследников токен обновляется и сохраняется в базу.

Таким образом, для использования методов, не предусмотренных библиотекой, но предусмотренных API, можно обновить токен, создав объект MzpoAmo и получив токен из бд
```php 
new MzpoAmo();
$access_Token = getToken();
```
Для примера см. [Методы CourseService](/amo/services/CoursesServise.php)

___
## Модели
В папке [model](/amo/model) содержатся классы-обертки дял основных сущностей библиотеки, облегчающие работу с изменением их свойств:
+ [Контакт](/amo/model/Contact.php) - модель для работы с контактами
+ [Лид](/amo/model/Leads.php) - модель для работы с лидами
+ [Курс](/amo/model/Course.php) - модель для работы с курсами (товарами)
+ [Log](/amo/model/Log.php) - вспомогательная модель для логирования
Исключение составляет класс [CourseService](/amo/services/CoursesServise.php), который реализует функционал по удаленю курсов (элементов списка для API), которого нет в библиотеке текущей версии.
___

## Очереди

Все точки входа отправляют входящие запросы в очередь на [сервер](https://hawk.rmq.cloudamqp.com/#/). За отправку отвечает класс [QueueService](/amo/services/QueueService.php). Файлы из директории [queue](/amo/queue) - подписчики очередей:
+ [webhooks](/amo/queue/webhooks.php) - принимает сообщения о входящих лидах
+ [leads](/amo/queue/leads.php) - принимает сообщения о входящих хуках
+ [1с](/amo/queue/1с.php) - принимает сообщения о входящих запросов для 1с

Для работы с очередями используется библиотека [php-amqplib](https://github.com/php-amqplib/php-amqplib), подробная документация с примерами на [сайте RabbitMQ](https://www.rabbitmq.com/getstarted.html)

Очереди используются для быстродействия - время ответа интеграции при отправке хука не должно превышать 2 секнуды.

При разработке новых хуков важно отлавливать исключения и забирать сообщения, иначе они будут приходить без оставновки:
```php
try{
//ваш код
} catch(AmoCRMApiException $e)
{
//логирование ошибки
$msg->ack()
}
```


___
## Хуки

[webhooks/index.php](/amo/webhooks/index.php) - точка входа для всех вебхуков amoCRM

[Полный список вебхуков](https://docs.google.com/spreadsheets/d/1_tFSuXGYM3u9ir7p-5Zw3H83GOVC_kXiy00KH8vuIks/edit#gid=0)

___
## Интеграция для 1С

[api/index.php](/amo/api/index.php) - точка входа для всех методов интеграции с 1c. Атовизм, оставшийся от первоначальной версии сервиса. Сейчас обслуживает только интеграцию с товарами из 1с.

В директории [model/1C](/amo/model/1C/) хранятся модели сущностей для интеграции:
+ [Contact1C](/amo/model/1C/Contact1C.php) - Клиент (Физическое лицо)
+ [Lead1C](/amo/model/1C/Lead1C.php) - Заявка на курс
+ [Company1C](/amo/model/1C/Company1C.php) - Контрагент (Юридическое лицо)

Все модели реализуют интерфейс: 
[Base1CInterface](/amo/model/1C/Base1CInterface.php) - общий интерфейс взаимодействия 1С и АМО - определяет два статических фабричных метода для конвертации моделей amoCRM в модели для 1с:
* ``Base1CInterface::fromAmo(MzpoAmo|int $model, string $subdomain)``
* ``Base1CInterface::from1C(array $array)``

### Конвертеры
#### fromAmo

По сути, фабричные методы - это статические конструкторы, а значит создают и возвращают объект класса, в котором определены. Все методы имплементных классов принимают два аргумента, один из которых не обязательный:
Соответствующий объект класса-наследника ``MzpoAmo`` (``MzpoAmo/Leads``, ``MzpoAmo/Contact``, ``MzpoAmo/Company``), либо идентификатор этой сущности в amoCRM (``int``) и строку с доменом (``string``), по-умолчанию равную домену розничного аккаунта:
```php
\MzpoAmo\Base1CInterface::fromAMO(MzpoAmo|int $model, string $type = \MzpoAmo\MzpoAmo::SUBDOMAIN)
```

Алгоритм методов примерно одинаковый:
1. Непосредственно создание сущности для 1с (вызов конструктора имплементного класса)
2. Получение модели (если метод был вызван с ID и доменом)
3. Инициализация полей сущности
4. Возрат созданной сущности

**Стоит обратить внимание**, что заполняются только собственные поля сущностей из amoCRM, связанные сущности при этом не учитываются, и обрабатываются только в методах ``Services\Integration1C``

Отправкой данных в 1С занимается класс ``Services\Request1C``. 
### Метод ``request($type, $method, $data = null)``
Базовый метод ``request($type, $method, $data = null)`` принимает 3 параметра:
+ ``$type`` - тип запроса (GET, POST и т.д)
+ ``$method`` - метод в 1с (последняя часть URL), например (EditApplication)
+ ``$data`` - тело для POST-запроса, для GET не обрабатывается

Метод возвращает массив с ответом из 1с, либо выбрасывает исключение

```php
$req = new \services\Request1C();
$data = $req->request('POST', 'EditApplication', 
  [
    'param' => 'value',
    'param1' => 'value1'
  ]
);
```

### Магические методы
Также в классе предусмотрены магические методы для упрощенной работы с методом request. 

Структура следующая: название_метода = метод_1с + "_" + тип_запроса

Аргументы: 
+ GET: uid в 1с - строка
+ POST: массив данных/объект

Пример:
```php
$req = new \services\Request1C();
$req->EditApplication_POST($data);
```

___
## Константы

  Директория [dict](/amo/dict) содержит интерфейсы-словари для хранения константных идентификаторов полей в системе:
+ [CustomFields](/amo/dict/CustomFields.php) - Кастомные поля заявок, контактов и курсов(товары)
+ [Pipelines](/amo/dict/Pipelines.php) - Идентификаторы всех воронок
+ [Statuses](/amo/dict/Statuses.php) - Идентификаторы статусов для воронок (основных, используемых)
+ [Tags](/amo/dict/Tags.php) - Идентификаторы тегов
+ [Users](/amo/dict/Users.php) - Идентификаторы пользователей
___

## Настройки

Папка [config](/amo/config) содержит конфигурационные файлы: 
+ [БД](/amo/config/db.php) - класс для подключения и работы с БД
+ [Helpers](/amo/config/helpers.php) - вспомогательные методы для сохранения и получения токена авторизации из базы
+ [GetToken](/amo/config/getToken.php) - скрипт из примеров к документации библиотеки для первичного обмена ключа доступа на токены. Используется 1 раз - при регистрации интеграции и первом подключении к амо, оставлен как пример на всякий случай

___
## Виджеты

Папка [vidgets](/amo/vidgets) содержит страницы виджетов для рабочего стола амо.

___

## Работа с кодом

Файл [index.php](/amo/index.php) - точка входа для работы с интеграцей с форм сайтов.


